import os

import numpy as np
import pytest

from cosmic_integration import ratesSampler


def test_help(mock_sys_argv):
    """
    Test that the help message can be printed without errors.
    """
    with mock_sys_argv(['--help']):
        with pytest.raises(SystemExit):
            ratesSampler.main()


def test_rate_file_generation(test_compas_h5, outdir, mock_sys_argv):
    """
    Test that the rate file can be generated without errors.
    """
    output_file = f"{outdir}/test_rate_file"
    in_fname = os.path.basename(test_compas_h5)
    in_path = os.path.dirname(test_compas_h5)
    param_alpha = ratesSampler.ALPHA_VALUES[0]
    param_sigma = ratesSampler.SIGMA_VALUES[0]
    param_sfra = ratesSampler.SFR_A_VALUES[0]
    param_sfrd = ratesSampler.SFR_D_VALUES[0]

    expected_out_fname = f"{output_file}.csv"
    if os.path.exists(expected_out_fname):
        os.remove(expected_out_fname)

    command = (
        "python_ratesSampler.py "
        f"-i {in_fname} "
        f"-p {in_path} "
        f"-a {param_alpha} "
        f"-s {param_sigma} "
        f"-A {param_sfra} "
        f"-D {param_sfrd} "
        "-n 1 "
        f"{output_file}"
    )

    with mock_sys_argv(command.split()):
        ratesSampler.main()

    assert os.path.exists(expected_out_fname), f"Output file {expected_out_fname} was not created."

    # Read the output file and check its contents
    lines = open(expected_out_fname, 'r').readlines()

    assert len(lines) == 1, "Output file should contain exactly one line."

    # load data
    data = np.array(lines[0].strip().split(','))
    assert data.shape == EXPECTED_DATA.shape, f"Output data shape {data.shape} does not match expected shape {EXPECTED_DATA.shape}."

    # Convert to float
    data = data.astype(float)
    np.testing.assert_allclose(data, EXPECTED_DATA, rtol=1e-5, atol=1e-8, )


# copied from first run
EXPECTED_DATA = np.array(
    [
     -0.5,0.1,0.005,4.2,113,15,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,7.531427572096581e-13,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,7.863851705958106e-183,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,1.7082881304376472e-27,7.02423371080057e-18,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,1.654651537435342e-05,1.7232350672045191,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,5.9054404902280465e-40,1.0034407381096325e-28,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0005170685995800627,8.278580093849661e-45,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,769.0864455858954,0.0003997573541638511,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,2.3896423655133043e-84,6.526330729860899e-66,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,8.116118676749076,47.13296125564897,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,177.3722790681585,2.5257885405291513e-23,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,1.62927946841619e-14,7.026323621720873e-07,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,2.086048871160755e-06,587.8569583765012,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,3.98757158010406e-19,2.508949268533309e-10,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.013037427520418705,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,217.18353803560166,26.116926588569005,0.99737585078033,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,9.169059694489851e-33,1.545682670671121e-26,2.922682573710183e-18,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,5.398319166192056e-22,6.412708756092004e-28,1.9501961490757644e-18,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,5.0500347514677296e-110,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,1.6747225688934274e-44,4.023842197492956e-31,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,4.345209013332989e-08,6.30044986803463,190.94915626070994,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,5.994357151532993e-199,3.126920051577126e-169,2.5960482192457273e-130,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,533.4973014078888,824.6257111319093,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,5.925839775485577e-06,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.012392451775636542,2466.2717130241663,0.2006210937798283,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0010554587423728344,729.76921106392,2.808723290049358e-17,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,303.3370658088598,2118.63512057416,1.076806032800504e-06,0.00036595319320843116,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,75.44935542525427,3.7207837189582386e-38,1.2939258855091701e-86,7.661791801427849e-69,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0017508411711648505,472.7966375136832,9.235054477469722e-19,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,2.1953787146879585e-41,2.343344324710888e-28,2.153480855457343e-53,3.580103611950916e-40,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,1026.29514797885,0.0006381620220597332,780.946584241336,7.522189428050582e-27,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,1.62366558380439e-10,0.0006812857080708329,0.05497451555868294,2.980176155768848e-18,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,2079.5573278034376,67.29925201424341,0.07188297854412502,1.0410082202413155e-75,2.8711246718132295e-62,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,1.8272954005146016,1471.6744747169748,1.8728747749093438e-16,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,303.31308688489946,727.8792826298793,2509.825172935995,5.587826637951901e-10,0.17310261779129102,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,377.1012094991771,61.95445316080592,304.02307663301883,1509.8854214108849,0.017285403261594754,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,594.1591335535073,2066.9524592684133,93.78863396118278,7.503528767485354e-13,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.02608607975774032,1.6897186713371615,1904.9935767765098,4.520962839832851,34.28344707018672,0.017592051674600442,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,577.1122350348338,264.29983628010734,1400.5400388051116,1530.8187345313966,269.1112241844643,7.547305928390252,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,310.56102365700207,2971.2941676977134,11.915528883939702,1361.0857514037014,0.6006536370207007,8.84556118477058e-24,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,286.1089295141798,1233.379265868232,11537.22887214885,0.02037519896017005,0.12360240328712584,2.302151300002529e-38,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,390.99186709229815,83.34507605110258,1.1987675106448694e-08,2.915720322416662e-49,3.027761598936638e-35,7.185998533302004e-24,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,13.603758082882111,1007.4478122850873,212.88229430113745,1669.2768006299157,0.17183969715771233,4.760206101034957e-17,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,684.0939203475219,3649.088867544435,623.1706577297385,1111.3471774549469,0.05063527563271337,20.655900926735637,6.45463239661441e-75,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,417.1542487338945,1786.131648917004,13050.136391925722,9408.23089299715,408.43572911918903,133.17533984097102,122.16341327580011,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,566.0229915127339,3222.3445134283606,12953.800530889603,9172.552675297318,1183.792511987526,795.4118881774417,8.094890875005996,0.154292189726467,0.0,0.0,0.0,0.0,0.0,0.0,0.0,442.5568713141377,10408.675488416682,11.829348861183595,0.1523932802719385,1.685994139734267,1171.3224351986098,427.001412475865,9.469271210099095,0.0,0.0,0.0,0.0,0.0,0.0,0.0,915.2649430580892,10846.472876906759,2446.6345200173946,99.65594863387042,1.5052993759693043,502.7199959459485,446.46316828971305,30.172010797690863,0.0,0.0,0.0,0.0,0.0,0.0,0.0,733.8855269484731,10613.921281050338,5638.878242439823,751.5632355817431,12282.851850029747,62.99740502538069,1.7613835250498615,0.049082260269109765,5.71653625022234e-250,0.0,0.0,0.0,0.0,0.0,0.0,2562.2467479504553,5713.999538185682,2995.912249136379,4684.714188884169,3082.0650604295292,2.822607061752122,0.34313238915877664,1103.5709284536758,5.489873285055181,0.0,0.0,0.0,0.0,0.0,0.0,1049.3794796045268,704.4394956256854,14059.335497331542,21503.11955878644,3.2594245836230495,1237.5060081078827,1370.3202159317004,487.23587501040055,0.047413093525743265,4.3315235896229193e-178,0.0,0.0,0.0,0.0,0.0,1511.937042282695,0.001576297835490216,4629.300582970565,7041.173151059885,4975.663419945926,582.0212534505742,2730.233320129798,160.37883611315112,493.31742649080144,5.917205122853892e-216,0.0,0.0,0.0,0.0,0.0,152.74188161849702,3656.017876048242,11422.547956609129,14119.465417034202,534.0311719221562,227.08044664925433,5583.447290317332,619.1728069200844,4.914540999589458,13.898015676315111,0.0,0.0,0.0,0.0,0.0,2691.5535378026116,11427.870960157412,20170.013197681183,10185.966626373229,598.7227373549991,35.28169878540169,4985.094208389146,113.80393606350226,1.2342951880025138e-16,9.578439206278524e-14,2.152619955696354e-13,0.0,0.0,0.0,0.0,2.4525991427946767,2238.5339469960013,6896.290695379992,10375.8217710687,5485.030793476798,503.0929486531862,992.9920735086787,2165.367926509359,0.07757876440018915,15.407160775803797,1.6513573666291634,0.0,0.0,0.0,0.0,1190.197130201812,2931.938089920995,10519.82056756238,5627.03718149751,6052.032098926671,461.59292856560944,1783.3033754707035,797.1805471787417,6.393806815315899,35.87024214819247,8.39324850394056,0.0,0.0,0.0,0.0,1202.218984403452,2461.9403114779775,5955.956526708514,19169.719392392948,2160.1343839612887,4893.02399829692,4659.006741914793,2.7971791350827457,504.8596675836464,1432.266305448394,74.51485721732075,3.865303755507856e-11,0.0,0.0,0.0,403.5304054199952,4412.751337233719,46216.81062867621,60389.33637460306,643.2159712504398,8050.10217281344,37.91657273286284,2421.610991285228,3933.950967066194,16.212277468298694,9.593756838533238,1.54571484193755e-35,0.0,0.0,0.0,1903.6234746651783,11892.543802013926,11149.528506056127,67431.32725537769,34330.267670867725,21738.19353704004,1317.2588173336167,289.07226339160616,1258.3322107595407,189.47669053493257,124.07864831530831,24.472425936755744,0.0,0.0,0.0,726.6207704281017,10854.705005320213,7695.45094346275,29376.514124243517,13335.013660599561,14952.784922456554,15321.133482127081,7115.965153212891,3160.209148464296,2496.948708665671,105.64166601764126,0.0005193469245652476,0.0,0.0,0.0,4683.807313021682,3733.8439983837507,17238.00017747484,32333.246311665393,6538.385359702243,3825.5246122751064,10785.514884829736,10389.66346955433,5291.783248435956,1719.0132120841718,231.7324915417639,11.228206493675575,0.028953129717654652,0.0,0.0,2092.802807166788,38978.668586103304,4326.350287534654,6180.313107063427,13071.011265287234,22726.78577793366,3257.084755115392,10940.331690130148,5592.973689520835,6404.01574681267,1290.9549449190195,301.71828446602836,4.8162669407549235,0.0,0.0,1832.6083252295036,6985.020035262726,14261.57863931379,27049.958151490428,2177.600132044422,2264.157753653331,1230.8320709247428,2134.5189323082627,7974.784724373905,3231.2831188270284,2074.4558380284793,133.2015347451054,23.585203553654082,0.0,0.0,2459.415340130942,17873.754065398047,29876.782661348112,54453.18400137867,14893.97350693155,19773.254343748977,5762.259080371112,16888.795820631163,14599.262365897992,1343.678410656186,80.75977843631453,165.98086469172745,21.704359125850655,0.0,0.0,886.0419289145109,11281.470254035707,29772.627552725266,31314.077336780847,26939.951313974212,14344.600204164857,1177.6868054716733,3186.7128004286246,11763.756724814593,4233.080281715637,2932.614420098249,1820.1087305198178,75.93994697150386,0.0,0.0,63.87265255222814,9275.250211362005,9400.309968898786,31312.992155868018,4952.594358099693,50995.621439822666,14126.638123264474,8474.378800202883,7811.474721485918,2628.4947284964815,194.35048777628333,3.658778485729707,0.004747175176535497,0.0,0.0,2301.8571617771827,7308.841345083812,23544.378521096987,42537.696117632375,11379.02335770114,20710.890455696375,8865.566173801113,3012.7237177629536,12165.864725474208,5063.111773775762,130.77799358458168,256.8020755153505,50.00634787503386,0.0,0.0,2141.907933535917,14195.236102283216,30814.981573393852,1909.563328879336,12630.397178344936,18936.50381461634,17941.29957048879,1895.1047209448288,894.0767369444919,2141.5395557339657,117.94571975577682,1180.4928994359127,25.45007733327182,0.0,0.0,1816.0917022139347,11530.600317882869,18135.0978898606,31436.8216497323,27535.569157951035,22908.596940712177,11038.830795849413,5344.844275241517,120.29416589611289,2228.500326599092,843.675855570756,9.78766532227967,36.525952434746166,0.0,0.0,1809.8032237174853,2718.059973658537,18074.982412387773,15452.134813129664,28360.483593415673,9007.686197678971,14130.543025119541,3535.5074665929315,7766.5577534266795,5211.155958460725,1373.5983558013445,1169.0842639977932,1.00841617101907,0.0,0.0,633.6006642256494,4069.165666625027,43571.74555046675,7136.682186533396,1254.7415927607822,47785.49572631036,9085.400964987934,11725.339570770993,10075.153303790043,5841.561190018326,936.5819209423801,335.15700814565275,0.7030542346589088,0.0,0.0,1311.5899439292907,7379.168191764368,6272.9437288260615,148.7170287383015,13710.293873681823,31215.12735727989,17029.122469971222,10070.755815485605,1244.4132748013922,2003.6442260476283,2815.6025270763525,1.056853172511938,1.9653311324909306e-10,0.0,0.0,1025.435944750956,3219.9345610534874,4960.290936120197,98.80014941410217,13749.105418454787,1759.7208787066045,21204.01237099726,1257.8365316650638,634.5199888213328,2679.1524169214613,1606.2427761321464,0.04362039415560802,1.0246575253086523e-65,0.0,0.0,0.12142682598073591,0.32942830852198157,6312.280415830648,1.0216275575426688,1490.4901319203054,3116.2825462126293,0.033566625612882796,1.876594318119665e-12,3.512379648388325e-34,2.4492243730688753e-52,5.16951549002129e-38,4.160547335183487e-27,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0
])
